# 修改密码功能说明

## 📝 功能概述

在个人中心增加了用户修改密码功能，位置在退出登录按钮旁边，方便用户随时更改密码，提升账户安全性。

## ✨ 功能特性

### 1. 界面设计
- **并排布局**：修改密码和退出登录按钮并排显示
- **图标标识**：使用钥匙图标（key-outline）表示修改密码
- **颜色区分**：
  - 修改密码：蓝色主题（#007AFF）
  - 退出登录：红色主题（#FF3B30）
- **油黑主题**：符合应用整体设计风格

### 2. 安全验证
- ✅ **原密码验证**：必须输入正确的原密码
- ✅ **密码长度限制**：新密码至少6个字符
- ✅ **密码确认**：两次输入新密码必须一致
- ✅ **防止重复**：新密码不能与原密码相同
- ✅ **必填验证**：所有密码字段都必须填写

### 3. 用户体验
- 🔒 **密码隐藏**：输入时密码字符自动隐藏
- 💬 **友好提示**：清晰的错误提示和成功提示
- 📱 **模态对话框**：使用模态窗口，不影响其他操作
- 🎯 **自动聚焦**：打开对话框自动聚焦到原密码输入框

## 🔧 技术实现

### 1. AuthContext 增强

#### 新增方法：changePassword

**文件**：`src/context/AuthContext.js`

```javascript
// 修改密码
const changePassword = async (oldPassword, newPassword) => {
  try {
    if (!user || !user.id) {
      throw new Error('用户信息不存在');
    }

    // 查找用户
    const userIndex = users.findIndex(u => u.id === user.id);
    if (userIndex === -1) {
      throw new Error('用户不存在');
    }

    // 验证旧密码
    if (users[userIndex].password !== oldPassword) {
      throw new Error('原密码错误');
    }

    // 验证新密码
    if (!newPassword || newPassword.length < 6) {
      throw new Error('新密码至少需要6个字符');
    }

    if (oldPassword === newPassword) {
      throw new Error('新密码不能与原密码相同');
    }

    // 更新密码
    users[userIndex].password = newPassword;

    return { success: true };
  } catch (error) {
    return { success: false, error: error.message };
  }
};
```

#### 导出到Context值
```javascript
const value = {
  user,
  loading,
  login,
  register,
  logout,
  updateUser,
  getUserById,
  changePassword,  // ✨ 新增
  isAdmin: user?.role === 'admin'
};
```

### 2. ProfileScreen 更新

#### 状态管理

**文件**：`src/screens/ProfileScreen.js`

```javascript
// 新增状态
const [isChangingPassword, setIsChangingPassword] = useState(false);
const [oldPassword, setOldPassword] = useState('');
const [newPassword, setNewPassword] = useState('');
const [confirmPassword, setConfirmPassword] = useState('');

// 导入changePassword方法
const { user, logout, updateUser, isAdmin, changePassword } = useAuth();
```

#### 事件处理函数

##### 1. 打开修改密码对话框
```javascript
const handleChangePassword = () => {
  setOldPassword('');
  setNewPassword('');
  setConfirmPassword('');
  setIsChangingPassword(true);
};
```

##### 2. 确认修改密码
```javascript
const handlePasswordConfirm = async () => {
  // 验证输入
  if (!oldPassword || !newPassword || !confirmPassword) {
    Alert.alert('错误', '请填写所有密码字段');
    return;
  }

  if (newPassword !== confirmPassword) {
    Alert.alert('错误', '两次输入的新密码不一致');
    return;
  }

  if (newPassword.length < 6) {
    Alert.alert('错误', '新密码至少需要6个字符');
    return;
  }

  // 调用修改密码方法
  const result = await changePassword(oldPassword, newPassword);

  if (result.success) {
    setIsChangingPassword(false);
    Alert.alert('成功', '密码修改成功');
  } else {
    Alert.alert('修改失败', result.error);
  }
};
```

##### 3. 取消修改
```javascript
const handlePasswordCancel = () => {
  setIsChangingPassword(false);
  setOldPassword('');
  setNewPassword('');
  setConfirmPassword('');
};
```

#### UI组件

##### 1. 按钮布局
```javascript
<View style={styles.actionContainer}>
  <TouchableOpacity style={styles.actionButton} onPress={handleChangePassword}>
    <Ionicons name="key-outline" size={20} color="#007AFF" />
    <Text style={styles.changePasswordButtonText}>修改密码</Text>
  </TouchableOpacity>
  
  <TouchableOpacity style={styles.logoutButton} onPress={handleLogout}>
    <Ionicons name="log-out-outline" size={20} color="#FF3B30" />
    <Text style={styles.logoutButtonText}>退出登录</Text>
  </TouchableOpacity>
</View>
```

##### 2. 修改密码模态框
```javascript
<Modal
  visible={isChangingPassword}
  transparent={true}
  animationType="slide"
  onRequestClose={handlePasswordCancel}
>
  <View style={styles.modalOverlay}>
    <View style={styles.modalContainer}>
      <Text style={styles.modalTitle}>修改密码</Text>
      
      {/* 原密码输入 */}
      <TextInput
        style={styles.modalInput}
        value={oldPassword}
        onChangeText={setOldPassword}
        placeholder="请输入原密码"
        placeholderTextColor="#999999"
        secureTextEntry
        autoFocus={true}
      />
      
      {/* 新密码输入 */}
      <TextInput
        style={styles.modalInput}
        value={newPassword}
        onChangeText={setNewPassword}
        placeholder="请输入新密码（至少6位）"
        placeholderTextColor="#999999"
        secureTextEntry
      />
      
      {/* 确认新密码 */}
      <TextInput
        style={styles.modalInput}
        value={confirmPassword}
        onChangeText={setConfirmPassword}
        placeholder="请再次输入新密码"
        placeholderTextColor="#999999"
        secureTextEntry
      />
      
      {/* 按钮 */}
      <View style={styles.modalButtonContainer}>
        <TouchableOpacity
          style={[styles.modalButton, styles.cancelButton]}
          onPress={handlePasswordCancel}
        >
          <Text style={styles.cancelButtonText}>取消</Text>
        </TouchableOpacity>
        
        <TouchableOpacity
          style={[styles.modalButton, styles.confirmButton]}
          onPress={handlePasswordConfirm}
        >
          <Text style={styles.confirmButtonText}>确定</Text>
        </TouchableOpacity>
      </View>
    </View>
  </View>
</Modal>
```

#### 样式定义

```javascript
actionContainer: {
  marginTop: 30,
  marginHorizontal: 15,
  marginBottom: 30,
  flexDirection: 'row',
  gap: 10,
},
actionButton: {
  flex: 1,
  backgroundColor: 'rgba(255, 255, 255, 0.08)',
  borderRadius: 16,
  padding: 15,
  flexDirection: 'row',
  alignItems: 'center',
  justifyContent: 'center',
  gap: 10,
  borderWidth: 1,
  borderColor: 'rgba(0, 122, 255, 0.3)',
},
changePasswordButtonText: {
  fontSize: 16,
  color: '#007AFF',
  fontWeight: '600',
},
logoutButton: {
  flex: 1,
  backgroundColor: 'rgba(255, 255, 255, 0.08)',
  borderRadius: 16,
  padding: 15,
  flexDirection: 'row',
  alignItems: 'center',
  justifyContent: 'center',
  gap: 10,
  borderWidth: 1,
  borderColor: 'rgba(255, 59, 48, 0.3)',
},
```

## 🚀 使用流程

### 1. 打开修改密码对话框
1. 登录应用
2. 进入个人中心
3. 点击"修改密码"按钮

### 2. 输入密码信息
1. **原密码**：输入当前使用的密码
2. **新密码**：输入想要设置的新密码（至少6位）
3. **确认密码**：再次输入新密码

### 3. 确认修改
- 点击"确定"按钮
- 系统验证并更新密码
- 显示成功提示

### 4. 验证新密码
- 退出登录
- 使用新密码重新登录
- 确认密码修改成功

## 🧪 测试场景

### 场景1：正常修改密码
```
步骤：
1. 登录账户（13800138000 / 123456）
2. 进入个人中心
3. 点击"修改密码"
4. 输入：
   - 原密码：123456
   - 新密码：abcd1234
   - 确认密码：abcd1234
5. 点击"确定"

预期结果：
✅ 显示"密码修改成功"
✅ 模态框关闭
✅ 使用新密码可以登录
```

### 场景2：原密码错误
```
步骤：
1. 点击"修改密码"
2. 输入：
   - 原密码：wrongpass
   - 新密码：newpass123
   - 确认密码：newpass123
3. 点击"确定"

预期结果：
❌ 显示"原密码错误"
✅ 保持在修改密码对话框
```

### 场景3：两次新密码不一致
```
步骤：
1. 点击"修改密码"
2. 输入：
   - 原密码：123456
   - 新密码：newpass123
   - 确认密码：newpass456
3. 点击"确定"

预期结果：
❌ 显示"两次输入的新密码不一致"
✅ 保持在修改密码对话框
```

### 场景4：新密码太短
```
步骤：
1. 点击"修改密码"
2. 输入：
   - 原密码：123456
   - 新密码：123
   - 确认密码：123
3. 点击"确定"

预期结果：
❌ 显示"新密码至少需要6个字符"
✅ 保持在修改密码对话框
```

### 场景5：新密码与原密码相同
```
步骤：
1. 点击"修改密码"
2. 输入：
   - 原密码：123456
   - 新密码：123456
   - 确认密码：123456
3. 点击"确定"

预期结果：
❌ 显示"新密码不能与原密码相同"
✅ 保持在修改密码对话框
```

### 场景6：取消修改
```
步骤：
1. 点击"修改密码"
2. 输入一些密码信息
3. 点击"取消"

预期结果：
✅ 模态框关闭
✅ 密码未修改
✅ 输入框内容清空
```

## 📊 验证规则

| 验证项 | 规则 | 错误提示 |
|--------|------|----------|
| 原密码 | 必填，且与当前密码匹配 | "原密码错误" |
| 新密码 | 必填，至少6个字符 | "新密码至少需要6个字符" |
| 确认密码 | 必填，与新密码一致 | "两次输入的新密码不一致" |
| 密码重复性 | 新密码不能与原密码相同 | "新密码不能与原密码相同" |
| 完整性 | 所有字段都必须填写 | "请填写所有密码字段" |

## 🎨 界面设计

### 按钮布局
```
┌─────────────────────────────────────┐
│  🔑 修改密码  │  🚪 退出登录  │
└─────────────────────────────────────┘
  (蓝色主题)      (红色主题)
```

### 模态对话框
```
┌───────────────────────────────┐
│        修改密码                │
├───────────────────────────────┤
│  [请输入原密码]  🔒           │
│  [请输入新密码（至少6位）] 🔒 │
│  [请再次输入新密码]  🔒       │
├───────────────────────────────┤
│  [取消]          [确定]       │
└───────────────────────────────┘
```

## ⚠️ 注意事项

### 1. 密码存储
- 当前版本密码以明文存储在内存中
- 仅用于开发和测试环境
- 生产环境需要使用加密存储

### 2. 数据持久化
- 密码修改后立即生效
- 应用重启后数据重置为初始状态
- 需要后端支持才能实现真正的持久化

### 3. 安全建议
- 建议设置更复杂的密码策略
- 可以添加密码强度检测
- 可以添加修改密码的频率限制
- 可以添加登录失败次数限制

### 4. 用户体验
- 修改密码后不会自动退出登录
- 用户可以继续使用当前会话
- 下次登录时需要使用新密码

## 🔄 后续优化建议

### 1. 密码强度检测
```javascript
// 添加密码强度验证
const checkPasswordStrength = (password) => {
  const hasNumber = /\d/.test(password);
  const hasLetter = /[a-zA-Z]/.test(password);
  const hasSpecial = /[!@#$%^&*]/.test(password);
  
  if (hasNumber && hasLetter && hasSpecial) {
    return '强';
  } else if (hasNumber && hasLetter) {
    return '中';
  } else {
    return '弱';
  }
};
```

### 2. 密码加密
```javascript
// 使用加密库存储密码
import CryptoJS from 'crypto-js';

const encryptPassword = (password) => {
  return CryptoJS.SHA256(password).toString();
};
```

### 3. 修改历史记录
```javascript
// 记录密码修改时间
const passwordChangeHistory = {
  lastChanged: Date.now(),
  changeCount: 1
};
```

### 4. 找回密码功能
- 通过手机号验证码找回
- 通过邮箱找回
- 添加安全问题验证

## ✅ 完成状态

- ✅ AuthContext添加changePassword方法
- ✅ ProfileScreen添加修改密码按钮
- ✅ 实现修改密码模态对话框
- ✅ 添加完整的验证逻辑
- ✅ 实现用户友好的提示信息
- ✅ 符合油黑主题设计风格
- ✅ 代码语法检查通过
- ✅ 无错误或警告

## 🎯 功能验证

修改密码功能可以完整验证以下能力：
1. ✅ 用户可以打开修改密码对话框
2. ✅ 系统正确验证原密码
3. ✅ 系统检查新密码长度
4. ✅ 系统验证两次密码输入一致性
5. ✅ 系统阻止新旧密码相同
6. ✅ 密码修改成功后可以使用新密码登录
7. ✅ 界面美观，符合应用设计风格

---

**更新时间**：2025-10-11  
**版本**：1.0  
**状态**：✅ 已完成并测试通过