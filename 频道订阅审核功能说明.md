# 频道订阅审核功能说明

## 功能概述

优化频道订阅功能，引入审核机制和会员期限管理系统，让频道主能够控制谁可以加入频道，并设置会员有效期。

## 核心功能

### 1. 订阅申请流程

#### 1.1 用户申请订阅
- 用户点击"订阅"按钮后，不会立即成为频道成员
- 按钮文字变为"等待频道主审核"
- 创建订阅申请记录
- 发送通知给频道主

#### 1.2 状态管理
```javascript
订阅状态：
- 未订阅: "订阅"按钮
- 申请中: "等待频道主审核"按钮（禁用状态）
- 已订阅: "已订阅"按钮
```

### 2. 频道主审核

#### 2.1 接收申请通知
- 频道主在消息页收到订阅申请提示
- 显示申请人信息（昵称、头像、手机号）
- 未读通知有红点提示

#### 2.2 审核操作

**通过申请**：
1. 点击"通过"按钮
2. 弹出期限选择对话框
3. 选择会员有效期：
   - 1个月（30天）
   - 3个月（90天）
   - 半年（180天）
   - 1年（365天）
4. 确认后用户立即成为频道成员
5. 记录会员过期时间

**拒绝申请**：
1. 点击"拒绝"按钮
2. 用户的订阅按钮恢复为"订阅"
3. 用户可以重新申请

### 3. 会员期限管理

#### 3.1 自动过期检查
- 系统每分钟检查一次会员过期情况
- 过期会员自动移出频道
- 订阅人数自动减少

#### 3.2 会员信息显示
- 频道详情页显示会员过期时间
- 提前提醒即将过期的会员

## 技术实现

### 1. 数据结构

#### Channel数据结构
```javascript
{
  id: string,
  name: string,
  subscribers: [userId], // 已审核通过的成员
  pendingRequests: [
    {
      id: string,
      userId: string,
      userNickname: string,
      userAvatar: string,
      userPhone: string,
      status: 'pending',
      requestTime: timestamp
    }
  ],
  memberExpiry: {
    userId: expiryTimestamp  // 每个成员的过期时间
  }
}
```

#### 订阅申请通知
```javascript
{
  id: string,
  type: 'subscription_request',
  channelId: string,
  channelName: string,
  userId: string,
  userNickname: string,
  userAvatar: string,
  userPhone: string,
  createdAt: timestamp,
  read: boolean
}
```

### 2. Context方法

#### ChannelContext
```javascript
// 申请订阅
requestSubscription(channelId, userId, userInfo)

// 取消申请
cancelSubscriptionRequest(channelId, userId)

// 检查是否有待审核申请
hasPendingRequest(channelId, userId)

// 获取频道的待审核申请
getChannelPendingRequests(channelId)

// 通过申请
approveSubscription(channelId, userId, duration)

// 拒绝申请
rejectSubscription(channelId, userId)

// 获取会员过期时间
getMemberExpiry(channelId, userId)

// 自动检查并移除过期成员
checkAndRemoveExpiredMembers()
```

#### SubscriptionNotificationContext
```javascript
// 创建订阅申请通知
createSubscriptionNotification(channelId, channelName, userId, userInfo)

// 获取频道主的通知
getCreatorNotifications(creatorChannelIds)

// 获取未读通知数
getUnreadCount(creatorChannelIds)

// 标记已读
markAsRead(notificationId)

// 删除通知
deleteNotification(notificationId)

// 处理申请后删除通知
handleRequestProcessed(channelId, userId)
```

### 3. 界面组件

#### 频道详情页
- 订阅按钮状态管理
- 显示"订阅"/"等待审核"/"已订阅"
- 点击订阅发起申请

#### 消息页
- 显示订阅申请通知
- 未读通知红点
- 点击通知打开审核对话框

#### 审核对话框
- 显示申请人信息
- 通过/拒绝按钮
- 期限选择对话框

### 4. 自动过期机制

```javascript
// 每分钟检查一次
useEffect(() => {
  const interval = setInterval(() => {
    checkAndRemoveExpiredMembers();
  }, 60000);
  
  return () => clearInterval(interval);
}, []);
```

## 使用流程

### 用户订阅流程
```
1. 用户点击"订阅"按钮
   ↓
2. 创建订阅申请
   ↓
3. 按钮变为"等待频道主审核"（禁用）
   ↓
4. 发送通知给频道主
   ↓
5. 等待审核结果
```

### 频道主审核流程
```
1. 消息页收到申请通知（红点提示）
   ↓
2. 点击通知查看申请人信息
   ↓
3a. 点击"通过"
    ↓
    选择会员期限
    ↓
    用户成为频道成员
    ↓
    设置过期时间
    
3b. 点击"拒绝"
    ↓
    用户订阅按钮恢复
    ↓
    可以重新申请
```

### 会员过期流程
```
1. 系统定时检查（每分钟）
   ↓
2. 发现过期会员
   ↓
3. 从subscribers列表移除
   ↓
4. 订阅人数-1
   ↓
5. 删除memberExpiry记录
   ↓
6. 用户订阅按钮恢复为"订阅"
```

## 文件修改清单

### 新增文件
1. `src/context/SubscriptionNotificationContext.js` - 订阅通知管理

### 修改文件
1. `src/context/ChannelContext.js` - 添加订阅审核功能
2. `src/screens/ChannelDetailScreen.js` - 订阅按钮状态管理
3. `src/screens/MessagesScreen.js` - 显示订阅申请通知
4. `App.js` - 注册SubscriptionNotificationProvider

### 新增组件
1. 订阅申请审核对话框
2. 会员期限选择对话框

## 测试场景

### 场景1：用户申请订阅
```
前置条件：用户未订阅频道
操作步骤：
1. 进入频道详情页
2. 点击"订阅"按钮
验证：
- 按钮变为"等待频道主审核"
- 按钮处于禁用状态
- 频道主收到通知
```

### 场景2：频道主通过申请
```
前置条件：有待审核的订阅申请
操作步骤：
1. 频道主进入消息页
2. 点击订阅申请通知
3. 点击"通过"按钮
4. 选择"1个月"
5. 点击确认
验证：
- 用户成为频道成员
- 用户订阅按钮变为"已订阅"
- 订阅人数+1
- 设置了过期时间
```

### 场景3：频道主拒绝申请
```
前置条件：有待审核的订阅申请
操作步骤：
1. 频道主进入消息页
2. 点击订阅申请通知
3. 点击"拒绝"按钮
验证：
- 申请被删除
- 用户订阅按钮恢复为"订阅"
- 用户可以重新申请
```

### 场景4：会员过期
```
前置条件：会员已过期
操作步骤：
1. 等待系统自动检查
验证：
- 用户从subscribers移除
- 订阅人数-1
- 用户订阅按钮恢复为"订阅"
```

## 注意事项

1. **性能考虑**
   - 过期检查间隔设为1分钟
   - 避免频繁检查影响性能

2. **数据一致性**
   - 申请通过后立即删除待审核记录
   - 过期后立即更新所有相关状态

3. **用户体验**
   - 清晰的按钮状态提示
   - 及时的通知反馈
   - 友好的错误提示

4. **扩展性**
   - 支持自定义会员期限
   - 支持会员续期功能
   - 支持会员权限管理

---
**版本**: 1.0
**状态**: 待实现
**更新时间**: 2025-10-11
